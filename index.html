<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FitnessOS</title>
    
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/84/84145.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/84/84145.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#020617">

    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap"> { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } } </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono&display=swap');
        body { background: #020617; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; color: #e2e8f0; margin: 0; }
        .glass-card { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.3s ease; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .active-tap:active { transform: scale(0.95); opacity: 0.8; }
    </style>
</head>
<body class="opacity-0 transition-opacity duration-500" id="app">

    <div id="error-display" class="hidden fixed inset-0 z-[100] bg-red-900/90 p-10 font-mono text-white text-xs"></div>

    <div class="fixed top-0 left-0 w-full z-50 bg-slate-900/95 backdrop-blur-md border-b border-slate-800 p-2">
        <div class="max-w-xl mx-auto flex items-center gap-2 px-2">
            <div class="flex-1">
                <div class="flex justify-between text-[9px] font-bold mb-1 text-blue-400 font-mono uppercase">
                    <span id="p-label">Protein Target</span> <span id="p-pct">0%</span>
                </div>
                <div class="w-full bg-slate-800 h-1 rounded-full overflow-hidden">
                    <div id="p-bar" class="bg-blue-500 h-full transition-all duration-700" style="width: 0%"></div>
                </div>
            </div>
            <button onclick="window.showHistory()" class="bg-slate-800 text-slate-400 text-[8px] px-2 py-1 rounded font-bold uppercase border border-slate-700 active-tap">History</button>
            <button onclick="window.shareSummary()" class="bg-blue-600 text-white text-[8px] px-2 py-1 rounded font-black uppercase active-tap">Report</button>
        </div>
    </div>

    <div class="max-w-xl mx-auto px-4 pt-16 pb-32">
        <div class="flex justify-between items-start mb-8">
            <div class="flex items-center gap-3">
                <img id="brand-icon" src="https://cdn-icons-png.flaticon.com/512/84/84145.png" class="w-8 h-8 invert opacity-80" alt="Dumbbell">
                <div>
                    <h1 class="text-2xl font-black italic tracking-tighter uppercase leading-none">Fitness<span id="brand-suffix" class="text-blue-500">OS</span></h1>
                    <p id="mode-text" class="text-[9px] text-slate-500 font-mono tracking-widest uppercase italic">Training Session</p>
                </div>
            </div>
            <div class="flex flex-col items-end">
                <div id="overall-grade" class="text-5xl font-black text-emerald-400 leading-none">A+</div>
                <button onclick="window.toggleRestMode()" id="rest-toggle" class="mt-2 text-[8px] font-bold px-3 py-1 rounded-full bg-slate-800 text-slate-400 border border-slate-700 uppercase active-tap">Rest Day: Off</button>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="glass-card p-4 rounded-3xl text-center border-b-2 border-blue-500/50">
                <p class="text-[8px] text-slate-500 uppercase font-mono mb-1">Protein</p>
                <p class="text-2xl font-black text-blue-400 tracking-tighter"><span id="total-p">0</span>g</p>
            </div>
            <div class="glass-card p-4 rounded-3xl text-center border-b-2 border-slate-700">
                <p class="text-[8px] text-slate-500 uppercase font-mono mb-1">Calories</p>
                <p class="text-2xl font-black text-white tracking-tighter" id="total-cal">0</p>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-6">
            <div class="glass-card p-4 rounded-3xl text-center border-l-2 border-orange-500/30">
                <p class="text-[8px] text-slate-500 uppercase font-mono mb-1">Carbs</p>
                <p class="text-xl font-black text-orange-400 tracking-tighter"><span id="total-c">0</span>g</p>
            </div>
            <div class="glass-card p-4 rounded-3xl text-center border-l-2 border-yellow-500/30">
                <p class="text-[8px] text-slate-500 uppercase font-mono mb-1">Fats</p>
                <p class="text-xl font-black text-yellow-400 tracking-tighter"><span id="total-f">0</span>g</p>
            </div>
        </div>

        <div class="glass-card p-5 rounded-3xl mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-[9px] font-bold text-slate-400 uppercase tracking-widest font-mono">Nutrition Log</h3>
                <button onclick="window.openModal()" class="bg-emerald-500 text-black font-black w-8 h-8 rounded-full shadow-lg text-lg active-tap">+</button>
            </div>
            <div id="food-log" class="space-y-2 max-h-40 overflow-y-auto pr-1"></div>
        </div>

        <div class="glass-card p-5 rounded-3xl mb-6 border-l-4 border-cyan-500">
            <p class="text-[9px] text-cyan-500 uppercase mb-3 font-mono tracking-widest font-bold">Hydration (1 Cup = 250ml)</p>
            <div class="flex items-center justify-between">
                <button onclick="window.addWater(-250)" class="bg-slate-800 text-white w-10 h-10 rounded-xl font-black active-tap border border-slate-700">−</button>
                <div class="text-center">
                    <div class="flex items-baseline justify-center">
                        <input type="number" id="water-total" value="0" oninput="window.saveAndRefresh()" class="bg-transparent text-2xl font-black font-mono text-white w-20 text-center outline-none border-none p-0 focus:ring-0">
                        <span class="text-[10px] text-slate-500 font-mono ml-[-5px]">ml</span>
                    </div>
                </div>
                <button onclick="window.addWater(250)" class="bg-cyan-600 text-white w-10 h-10 rounded-xl font-black active-tap shadow-lg">+</button>
            </div>
        </div>

        <div id="workout-section" class="glass-card p-6 rounded-3xl border-l-4 border-blue-500 mb-6 transition-all duration-500">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-[9px] font-bold text-blue-400 uppercase tracking-widest font-mono">Workout Scan</h3>
                <span id="work-val" class="text-blue-400 font-black text-lg">0%</span>
            </div>
            <label class="w-full bg-slate-800/50 border-2 border-dashed border-slate-700 rounded-2xl p-6 text-center cursor-pointer block">
                <input type="file" id="workout-img" accept="image/*" class="hidden" onchange="window.analyzeWorkout()">
                <span id="ai-status" class="text-[10px] text-slate-400 font-mono uppercase tracking-widest">Upload Plan Photo</span>
            </label>
        </div>

        <div class="glass-card p-5 rounded-3xl mb-12 border-l-4 border-emerald-500">
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-slate-800/50 rounded-xl p-3">
                    <p class="text-[8px] text-slate-600 uppercase mb-1 font-bold">Sleep</p>
                    <input type="number" id="sleep-hours" placeholder="Hrs" oninput="window.saveAndRefresh()" class="bg-transparent w-full outline-none text-xs border-none p-0">
                </div>
                <div class="bg-slate-800/50 rounded-xl p-3">
                    <p class="text-[8px] text-slate-600 uppercase mb-1 font-bold">Cardio</p>
                    <input type="number" id="cardio-mins" placeholder="Min" oninput="window.saveAndRefresh()" class="bg-transparent w-full outline-none text-xs border-none p-0">
                </div>
            </div>
        </div>
        
        <button onclick="window.archiveDayToSheet()" class="w-full bg-white text-black font-black py-4 rounded-2xl uppercase text-xs tracking-widest italic active-tap">Archive Day & Sync</button>
    </div>

    <div id="macro-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 bg-black/95">
        <div class="glass-card w-full max-w-sm p-6 rounded-3xl border border-emerald-500/30">
            <input id="manual-name" type="text" placeholder="Meal Name" class="w-full bg-slate-800 p-4 rounded-xl mb-4 text-sm outline-none border-none">
            <div class="grid grid-cols-3 gap-3 mb-6">
                <input id="manual-p" type="number" placeholder="P" class="bg-slate-800 p-4 rounded-xl text-center text-sm">
                <input id="manual-c" type="number" placeholder="C" class="bg-slate-800 p-4 rounded-xl text-center text-sm">
                <input id="manual-f" type="number" placeholder="F" class="bg-slate-800 p-4 rounded-xl text-center text-sm">
            </div>
            <div class="flex gap-2">
                <button onclick="window.closeModal()" class="flex-1 bg-slate-800 py-4 rounded-xl text-[10px] font-bold uppercase">Cancel</button>
                <button onclick="window.logManualMeal()" class="flex-1 bg-emerald-500 text-black py-4 rounded-xl text-[10px] font-bold uppercase">Save</button>
            </div>
        </div>
    </div>

    <div id="history-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 bg-black/95">
        <div class="glass-card w-full max-w-md p-6 rounded-3xl max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black italic uppercase">Sync History</h2>
                <button onclick="window.hideHistory()" class="text-slate-500 text-xs font-bold uppercase">Close</button>
            </div>
            <div id="history-list" class="space-y-3 font-mono text-[9px]"></div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        try {
            const PIN = "0805";
            const GEMINI_KEY = "AIzaSyBhHxGnIsxERj2-J0BADPPRyv0CXTfcWRU";
            const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbzmdHg7YupEXPLeEFVxdB_u3FDROh_vvbGUGhgLfOwuWmBRwdBZPt1Vp6A3JeUxbZUtbQ/exec";
            
            const genAI = new GoogleGenerativeAI(GEMINI_KEY);
            const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

            let dailyMeals = [];
            let workoutIntensity = 0;
            let isRestDay = false;

            window.onload = () => {
                const access = prompt("PIN:");
                if (access !== PIN) { 
                    document.body.innerHTML = "<div class='p-20 text-red-500'>LOCKED</div>"; 
                    document.body.style.opacity = "1";
                } else { 
                    document.getElementById('app').style.opacity = "1"; 
                    loadData(); 
                }
            };

            window.toggleRestMode = () => {
                isRestDay = !isRestDay;
                const btn = document.getElementById('rest-toggle');
                const workoutSec = document.getElementById('workout-section');
                const suffix = document.getElementById('brand-suffix');
                const modeText = document.getElementById('mode-text');

                if (isRestDay) {
                    btn.innerText = "Rest Day: On";
                    workoutSec.classList.add('hidden');
                    suffix.className = "text-purple-500";
                    modeText.innerText = "Recovery Mode";
                } else {
                    btn.innerText = "Rest Day: Off";
                    workoutSec.classList.remove('hidden');
                    suffix.className = "text-blue-500";
                    modeText.innerText = "Training Session";
                }
                saveAndRefresh();
            };

            window.addWater = (amt) => {
                const el = document.getElementById('water-total');
                el.value = Math.max(0, (parseInt(el.value) || 0) + amt);
                saveAndRefresh();
            };

            window.logManualMeal = () => {
                const p = parseFloat(document.getElementById('manual-p').value) || 0;
                const c = parseFloat(document.getElementById('manual-c').value) || 0;
                const f = parseFloat(document.getElementById('manual-f').value) || 0;
                dailyMeals.push({ id: Date.now(), name: document.getElementById('manual-name').value || "Meal", p, c, f, cal: (p*4)+(c*4)+(f*9) });
                window.closeModal(); saveAndRefresh();
            };

            window.analyzeWorkout = async () => {
                const file = document.getElementById('workout-img').files[0];
                if(!file || isRestDay) return;
                document.getElementById('ai-status').innerText = "AI Scanning...";
                const reader = new FileReader();
                reader.onloadend = async () => {
                    const base64 = reader.result.split(',')[1];
                    try {
                        const result = await model.generateContent([
                            "Estimate workout intensity 0-100 based on this plan. Return ONLY the number.",
                            { inlineData: { data: base64, mimeType: file.type } }
                        ]);
                        workoutIntensity = parseInt(result.response.text().trim()) || 0;
                        document.getElementById('work-val').innerText = workoutIntensity + "%";
                        document.getElementById('ai-status').innerText = "Verified ✓";
                        saveAndRefresh();
                    } catch (e) { document.getElementById('ai-status').innerText = "Scan Failed"; }
                };
                reader.readAsDataURL(file);
            };

            window.archiveDayToSheet = async () => {
                const t = getTotals();
                const entry = {
                    date: new Date().toLocaleDateString(),
                    p: t.p.toFixed(1), c: t.c.toFixed(1), f: t.f.toFixed(1), cal: Math.round(t.cal),
                    workout: isRestDay ? "REST" : workoutIntensity, 
                    water: document.getElementById('water-total').value,
                    grade: document.getElementById('overall-grade').innerText
                };
                let history = JSON.parse(localStorage.getItem("fit_os_history")) || [];
                history.unshift(entry);
                localStorage.setItem("fit_os_history", JSON.stringify(history.slice(0, 10)));
                await fetch(GOOGLE_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(entry) });
                alert("Day Synced.");
            };

            function getTotals() {
                return dailyMeals.reduce((acc, m) => ({
                    p: acc.p + m.p, c: acc.c + m.c, f: acc.f + m.f, cal: acc.cal + m.cal
                }), {p:0, c:0, f:0, cal:0});
            }

            window.saveAndRefresh = () => {
                const t = getTotals();
                document.getElementById('total-p').innerText = t.p.toFixed(1);
                document.getElementById('total-c').innerText = t.c.toFixed(1);
                document.getElementById('total-f').innerText = t.f.toFixed(1);
                document.getElementById('total-cal').innerText = Math.round(t.cal);
                
                let score = (Math.min(t.p/180, 1)*60) + (Math.min(document.getElementById('sleep-hours').value/8, 1)*30);
                if (!isRestDay) score = (score * 0.7) + (workoutIntensity * 0.3);

                const dg = document.getElementById('overall-grade');
                dg.innerText = score > 85 ? 'A+' : (score > 60 ? 'B' : 'C');
                dg.className = `text-5xl font-black leading-none ${score > 85 ? 'text-emerald-400' : 'text-blue-400'}`;
                
                document.getElementById('p-bar').style.width = Math.min((t.p/180)*100, 100) + "%";
                document.getElementById('p-pct').innerText = Math.round(Math.min((t.p/180)*100, 100)) + "%";

                localStorage.setItem("fit_os_pro_v8", JSON.stringify({
                    meals: dailyMeals, water: document.getElementById('water-total').value,
                    workout: workoutIntensity, sleep: document.getElementById('sleep-hours').value,
                    cardio: document.getElementById('cardio-mins').value, date: new Date().toLocaleDateString(),
                    rest: isRestDay
                }));
                renderFoodLog();
            };

            function renderFoodLog() {
                document.getElementById('food-log').innerHTML = dailyMeals.map(m => `
                    <div class="flex justify-between items-center bg-slate-900/60 p-3 rounded-2xl border border-slate-800 mb-2">
                        <p class="text-[10px] font-bold uppercase truncate flex-1">${m.name}</p>
                        <button onclick="window.deleteMeal(${m.id})" class="text-slate-600 text-[9px] font-bold ml-2">DEL</button>
                    </div>
                `).join('');
            }

            window.showHistory = () => {
                const list = JSON.parse(localStorage.getItem("fit_os_history")) || [];
                document.getElementById('history-list').innerHTML = list.map(h => `
                    <div class="bg-slate-900/40 p-3 rounded-2xl border border-slate-800 mb-2">
                        <div class="flex justify-between mb-1">
                            <span class="text-blue-400 font-bold">${h.date}</span>
                            <span class="text-emerald-400 font-black">${h.grade}</span>
                        </div>
                        <div class="text-slate-500 uppercase text-[8px]">P:${h.p}g | CAL:${h.cal} | W:${h.workout}</div>
                    </div>
                `).join('');
                document.getElementById('history-modal').classList.remove('hidden');
            };

            window.hideHistory = () => document.getElementById('history-modal').classList.add('hidden');
            window.deleteMeal = (id) => { dailyMeals = dailyMeals.filter(m => m.id !== id); window.saveAndRefresh(); };
            window.openModal = () => document.getElementById('macro-modal').classList.remove('hidden');
            window.closeModal = () => document.getElementById('macro-modal').classList.add('hidden');
            window.shareSummary = () => {
                const t = getTotals();
                alert(`P: ${t.p.toFixed(1)}g | C: ${t.c.toFixed(1)}g | F: ${t.f.toFixed(1)}g`);
            };
            
            function loadData() {
                const s = JSON.parse(localStorage.getItem("fit_os_pro_v8"));
                if(s && s.date === new Date().toLocaleDateString()) {
                    dailyMeals = s.meals || []; 
                    document.getElementById('water-total').value = s.water || 0;
                    workoutIntensity = s.workout || 0; 
                    document.getElementById('work-val').innerText = workoutIntensity + "%";
                    document.getElementById('sleep-hours').value = s.sleep || ""; 
                    document.getElementById('cardio-mins').value = s.cardio || "";
                    if(s.rest) windo
