<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FitnessOS</title>
    
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3048/3048398.png">
    <meta name="apple-mobile-web-app-title" content="FitnessOS">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#020617">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono&display=swap');
        body { background: #020617; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass-card { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); }
        input[type=range] { accent-color: #3b82f6; }
        .custom-scrollbar::-webkit-scrollbar { width: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="text-slate-200 opacity-0 transition-opacity duration-500" id="app">

    <div class="fixed top-0 left-0 w-full z-50 bg-slate-900/90 backdrop-blur-md border-b border-slate-800 p-2">
        <div class="max-w-xl mx-auto flex items-center gap-3">
            <div class="flex-1">
                <div class="flex justify-between text-[10px] font-bold mb-1 text-blue-400 font-mono">
                    <span>PROTEIN (180G)</span> <span id="p-pct">0%</span>
                </div>
                <div class="w-full bg-slate-800 h-1.5 rounded-full overflow-hidden">
                    <div id="p-bar" class="bg-blue-500 h-full transition-all duration-700 shadow-[0_0_10px_#3b82f6]" style="width: 0%"></div>
                </div>
            </div>
            <button onclick="shareSummary()" class="bg-blue-600 text-[10px] px-3 py-1 rounded-lg font-bold uppercase">Share</button>
        </div>
    </div>

    <div class="max-w-xl mx-auto px-4 pt-16 pb-32">
        <div class="flex justify-between items-end mb-8">
            <div>
                <h1 class="text-2xl font-black text-white italic tracking-tighter uppercase leading-none">Fitness<span class="text-blue-500">OS</span></h1>
                <p class="text-[9px] text-slate-500 font-mono uppercase tracking-[0.2em]">Cloud Database: Active</p>
            </div>
            <div class="text-right">
                <div id="overall-grade" class="text-5xl font-black text-emerald-400 leading-none">A+</div>
                <p class="text-[10px] text-slate-500 uppercase font-mono tracking-widest">Grade</p>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6 text-center font-mono">
            <div class="glass-card p-4 rounded-3xl border-b-2 border-blue-500/50">
                <p class="text-[9px] text-slate-500 uppercase mb-1">Protein</p>
                <p class="text-2xl font-black text-blue-400"><span id="total-p">0</span>g</p>
            </div>
            <div class="glass-card p-4 rounded-3xl border-b-2 border-slate-500/50">
                <p class="text-[9px] text-slate-500 uppercase mb-1">Calories</p>
                <p class="text-2xl font-black text-white" id="total-cal">0</p>
            </div>
        </div>

        <div class="glass-card p-4 rounded-3xl mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest font-mono">Nutrition Intake</h3>
                <button onclick="openModal()" class="bg-emerald-500 text-black font-black w-8 h-8 rounded-full shadow-lg text-lg">+</button>
            </div>
            
            <div class="flex gap-2 mb-6">
                <input id="food-input" type="text" placeholder="Quick Search (e.g. 100g oats)" class="flex-1 bg-slate-800/50 rounded-2xl p-4 text-sm focus:ring-1 focus:ring-blue-500 outline-none border-none">
                <button onclick="searchFood()" class="bg-slate-800 px-4 rounded-2xl text-blue-400 font-bold">ADD</button>
            </div>

            <div id="food-log" class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar pr-1">
                </div>
        </div>

        <div class="glass-card p-4 rounded-3xl mb-6 border-l-4 border-yellow-500">
            <h3 class="text-[10px] font-bold text-yellow-500 uppercase mb-3 tracking-widest font-mono">Meal Library</h3>
            <div id="meal-library" class="flex flex-wrap gap-2"></div>
        </div>

        <div class="grid grid-cols-1 gap-4 mb-6">
            <div class="glass-card p-5 rounded-3xl flex items-center justify-between border-l-4 border-cyan-500">
                <div>
                    <p class="text-[10px] text-cyan-500 uppercase mb-1 font-mono tracking-widest">Hydration</p>
                    <p class="text-lg font-black font-mono text-white"><span id="water-total">0</span><span class="text-xs text-slate-500">ml</span></p>
                </div>
                <button onclick="addWater()" class="bg-cyan-900/30 text-cyan-400 px-6 py-3 rounded-2xl border border-cyan-500/20 active:scale-95 transition-all font-bold">+ 250ml</button>
            </div>
            <div class="glass-card p-5 rounded-3xl border-l-4 border-orange-500">
                <h3 class="text-[10px] text-orange-500 uppercase mb-3 font-mono tracking-widest font-bold">Today's Meal Plan</h3>
                <textarea id="meal-plan-input" placeholder="Meal 1: Oats & Whey..." class="w-full bg-transparent border-none p-0 text-sm text-slate-400 focus:ring-0 h-16 resize-none custom-scrollbar"></textarea>
            </div>
        </div>

        <div class="glass-card p-6 rounded-3xl mb-12">
            <div class="mb-6">
                <label class="flex justify-between text-[10px] font-bold mb-4 font-mono uppercase tracking-widest"><span>Workout Intensity</span><span id="work-val" class="text-blue-400">50%</span></label>
                <input type="range" id="workout-range" value="50" class="w-full h-1.5 bg-slate-800 rounded-lg appearance-none cursor-pointer">
            </div>
            <div class="grid grid-cols-2 gap-4 font-mono text-xs text-center">
                <div>
                    <label class="block text-[10px] text-slate-600 mb-2 uppercase">Sleep Hrs</label>
                    <input type="number" id="sleep-hours" placeholder="8" class="bg-slate-800 rounded-xl p-3 w-full border-none focus:ring-1 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-[10px] text-slate-600 mb-2 uppercase">Cardio Min</label>
                    <input type="number" id="cardio-mins" placeholder="30" class="bg-slate-800 rounded-xl p-3 w-full border-none focus:ring-1 focus:ring-blue-500">
                </div>
            </div>
        </div>
    </div>

    <div id="macro-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 bg-black/95 backdrop-blur-sm">
        <div class="glass-card w-full max-w-sm p-6 rounded-3xl border border-emerald-500/30">
            <h2 id="modal-title" class="text-xl font-black mb-6 text-white italic uppercase tracking-tighter">Log Meal</h2>
            <div class="space-y-4">
                <input id="manual-name" type="text" placeholder="Meal Name" class="w-full bg-slate-800 p-4 rounded-xl outline-none focus:ring-1 focus:ring-emerald-500 border-none">
                <div class="grid grid-cols-3 gap-3 font-mono">
                    <input id="manual-p" type="number" placeholder="P" class="bg-slate-800 p-4 rounded-xl text-center">
                    <input id="manual-c" type="number" placeholder="C" class="bg-slate-800 p-4 rounded-xl text-center">
                    <input id="manual-f" type="number" placeholder="F" class="bg-slate-800 p-4 rounded-xl text-center">
                </div>
                <div id="save-lib-container" class="flex items-center gap-2 text-[10px] text-slate-500 font-mono">
                    <input type="checkbox" id="save-to-library" class="w-4 h-4 rounded accent-emerald-500">
                    SAVE TO MEAL LIBRARY
                </div>
                <div class="flex gap-2 pt-4">
                    <button onclick="closeModal()" class="flex-1 bg-slate-800 py-4 rounded-xl text-xs font-bold uppercase">Cancel</button>
                    <button id="modal-action-btn" onclick="logManualMeal()" class="flex-1 bg-emerald-500 text-black py-4 rounded-xl text-xs font-bold uppercase">Save</button>
                </div>
            </div>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 w-full p-4 bg-slate-900/95 backdrop-blur-xl border-t border-slate-800 z-40 safe-area-bottom">
        <div class="max-w-xl mx-auto flex gap-3">
            <button onclick="alert('Day synced with Google Sheets')" class="flex-1 bg-white text-black font-black py-4 rounded-2xl uppercase tracking-tighter text-sm active:scale-95 transition-all">Archive Day</button>
            <button onclick="resetDay()" class="bg-slate-800 px-6 rounded-2xl text-slate-400">â†º</button>
        </div>
    </div>

    <script>
        const PIN = "0805";
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzmdHg7YupEXPLeEFVxdB_u3FDROh_vvbGUGhgLfOwuWmBRwdBZPt1Vp6A3JeUxbZUtbQ/exec"; 
        const STORAGE_KEY = "fitness_os_v2_data";
        const LIB_KEY = "fitness_os_v2_lib";
        const TARGET_P = 180;

        let dailyMeals = [];
        let editingMealId = null;

        const MY_KITCHEN = {
            "oats": { p: 13, cal: 389, c: 66, f: 7 },
            "whey": { p: 25, cal: 120, c: 3, f: 1.5 },
            "laban": { p: 3.5, cal: 60, c: 4.5, f: 3.3 },
            "date": { p: 0.5, cal: 66, c: 18, f: 0 }
        };

        window.onload = () => {
            const access = prompt("PIN REQUIRED:");
            if (access !== PIN) {
                document.body.innerHTML = "<div class='h-screen flex items-center justify-center text-red-500 font-mono text-xs'>UNAUTHORIZED ACCESS</div>";
                document.body.style.opacity = "1";
            } else {
                document.getElementById('app').style.opacity = "1";
                loadData();
                renderLibrary();
                renderFoodLog();
            }
        };

        function openModal(id = null) {
            editingMealId = id;
            const modal = document.getElementById('macro-modal');
            const title = document.getElementById('modal-title');
            const btn = document.getElementById('modal-action-btn');
            const libRow = document.getElementById('save-lib-container');

            if (id) {
                const meal = dailyMeals.find(m => m.id === id);
                document.getElementById('manual-name').value = meal.name;
                document.getElementById('manual-p').value = meal.p;
                document.getElementById('manual-c').value = meal.c;
                document.getElementById('manual-f').value = meal.f;
                title.innerText = "Edit Entry"; btn.innerText = "Update"; libRow.classList.add('hidden');
            } else {
                document.querySelectorAll('#macro-modal input:not([type=checkbox])').forEach(i => i.value = "");
                title.innerText = "Log Meal"; btn.innerText = "Log Meal"; libRow.classList.remove('hidden');
            }
            modal.classList.remove('hidden');
        }

        function closeModal() { document.getElementById('macro-modal').classList.add('hidden'); }

        function logManualMeal() {
            const name = document.getElementById('manual-name').value || "Meal";
            const p = parseFloat(document.getElementById('manual-p').value) || 0;
            const c = parseFloat(document.getElementById('manual-c').value) || 0;
            const f = parseFloat(document.getElementById('manual-f').value) || 0;
            const cal = (p * 4) + (c * 4) + (f * 9);

            if (editingMealId) {
                const idx = dailyMeals.findIndex(m => m.id === editingMealId);
                dailyMeals[idx] = { ...dailyMeals[idx], name, p, c, f, cal };
            } else {
                if (document.getElementById('save-to-library').checked) saveToLib(name, p, c, f);
                dailyMeals.push({ id: Date.now(), name, p, c, f, cal });
            }

            closeModal(); saveAndRefresh(); sendToSheet(name, p, c, f, cal);
        }

        function deleteMeal(id) {
            dailyMeals = dailyMeals.filter(m => m.id !== id);
            saveAndRefresh();
        }

        async function searchFood() {
            const input = document.getElementById('food-input').value.toLowerCase();
            if(!input) return;
            for (let item in MY_KITCHEN) {
                if (input.includes(item)) {
                    const data = MY_KITCHEN[item];
                    let mult = 1;
                    const amount = input.match(/\d+/);
                    if (amount) mult = (input.includes("g") || input.includes("ml")) ? parseInt(amount[0]) / 100 : parseInt(amount[0]);
                    const p = data.p * mult, c = data.c * mult, f = data.f * mult;
                    dailyMeals.push({ id: Date.now(), name: input, p, c, f, cal: (p*4)+(c*4)+(f*9) });
                    saveAndRefresh(); sendToSheet(input, p, c, f, (p*4)+(c*4)+(f*9));
                    break;
                }
            }
            document.getElementById('food-input').value = "";
        }

        function renderFoodLog() {
            const log = document.getElementById('food-log');
            log.innerHTML = dailyMeals.map(m => `
                <div class="flex justify-between items-center bg-slate-900/60 p-3 rounded-2xl border border-slate-800 animate-in fade-in slide-in-from-bottom-2">
                    <div class="flex-1">
                        <p class="text-[11px] font-bold text-slate-100 uppercase tracking-tight">${m.name}</p>
                        <p class="text-[9px] text-slate-500 font-mono">${m.p}P | ${m.c}C | ${m.f}F</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openModal(${m.id})" class="text-slate-500 text-[10px] font-bold uppercase">Edit</button>
                        <button onclick="deleteMeal(${m.id})" class="text-slate-600 text-[10px] font-bold uppercase">Del</button>
                    </div>
                </div>
            `).join('');
            
            const sums = dailyMeals.reduce((acc, m) => ({p: acc.p + m.p, cal: acc.cal + m.cal}), {p:0, cal:0});
            document.getElementById('total-p').innerText = sums.p.toFixed(1);
            document.getElementById('total-cal').innerText = Math.round(sums.cal);
            calculateGrade(sums.p);
        }

        function renderLibrary() {
            const lib = JSON.parse(localStorage.getItem(LIB_KEY)) || [];
            document.getElementById('meal-library').innerHTML = lib.map(m => `
                <button onclick="quickLogLib('${m.name}', ${m.p}, ${m.c}, ${m.f})" class="bg-slate-800 px-3 py-2 rounded-xl text-[10px] font-bold border border-slate-700 uppercase">${m.name}</button>
            `).join('');
        }

        function quickLogLib(name, p, c, f) {
            dailyMeals.push({ id: Date.now(), name, p, c, f, cal: (p*4)+(c*4)+(f*9) });
            saveAndRefresh();
        }

        function calculateGrade(p) {
            const w = document.getElementById('workout-range').value;
            const s = document.getElementById('sleep-hours').value || 0;
            const score = (Math.min(p/TARGET_P, 1)*50) + (w*0.3) + (Math.min(s/8, 1)*20);
            let grade = 'F', color = 'text-red-500';
            if (score >= 90) { grade = 'A+'; color = 'text-emerald-400'; }
            else if (score >= 70) { grade = 'B'; color = 'text-blue-400'; }
            else if (score >= 50) { grade = 'C'; color = 'text-yellow-500'; }
            
            const display = document.getElementById('overall-grade');
            display.innerText = grade;
            display.className = `text-5xl font-black leading-none ${color}`;
            
            const pPct = Math.min((p/TARGET_P)*100, 100);
            document.getElementById('p-bar').style.width = pPct + "%";
            document.getElementById('p-pct').innerText = Math.round(pPct) + "%";
            document.getElementById('work-val').innerText = w + "%";
        }

        function saveAndRefresh() {
            const data = {
                meals: dailyMeals,
                w: document.getElementById('workout-range').value,
                s: document.getElementById('sleep-hours').value,
                c: document.getElementById('cardio-mins').value,
                water: document.getElementById('water-total').innerText,
                plan: document.getElementById('meal-plan-input').value,
                date: new Date().toLocaleDateString()
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            renderFoodLog();
        }

        function loadData() {
            const saved = JSON.parse(localStorage.getItem(STORAGE_KEY));
            if (saved && saved.date === new Date().toLocaleDateString()) {
                dailyMeals = saved.meals || [];
                document.getElementById('workout-range').value = saved.w;
                document.getElementById('sleep-hours').value = saved.s;
                document.getElementById('cardio-mins').value = saved.c;
                document.getElementById('water-total').innerText = saved.water;
                document.getElementById('meal-plan-input').value = saved.plan;
            }
        }

        function shareSummary() {
            const p = document.getElementById('total-p').innerText;
            const cal = document.getElementById('total-cal').innerText;
            const grade = document.getElementById('overall-grade').innerText;
            const text = `FITNESS OS LOG\nGrade: ${grade}\nProtein: ${p}g\nCalories: ${cal}kcal`;
            navigator.clipboard.writeText(text).then(() => alert("Copied to clipboard!"));
        }

        function addWater() {
            const el = document.getElementById('water-total');
            el.innerText = parseInt(el.innerText) + 250;
            saveAndRefresh();
        }

        function saveToLib(name, p, c, f) {
            let lib = JSON.parse(localStorage.getItem(LIB_KEY)) || [];
            if (!lib.find(m => m.name === name)) {
                lib.push({ name, p, c, f });
                localStorage.setItem(LIB_KEY, JSON.stringify(lib));
                renderLibrary();
            }
        }

        async function sendToSheet(name, p, c, f, cal) {
            if(GOOGLE_SCRIPT_URL.includes("PASTE")) return;
            const payload = { name, p, c, f, cal, 
                workout: document.getElementById('workout-range').value,
                sleep: document.getElementById('sleep-hours').value || 0,
                cardio: document.getElementById('cardio-mins').value || 0
            };
            fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        }

        function resetDay() { if(confirm("Wipe cache?")) { localStorage.clear(); location.reload(); } }
        document.querySelectorAll('input, textarea').forEach(i => i.addEventListener('input', saveAndRefresh));
    </script>
</body>
</html>
