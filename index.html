<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FitnessOS Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap"> { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } } </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background: #020617; font-family: 'Inter', sans-serif; color: #e2e8f0; margin: 0; overflow-x: hidden; }
        .glass-card { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .panel-title { font-size: 16px; font-weight: 900; letter-spacing: 0.15em; text-transform: uppercase; color: #cbd5e1; margin-bottom: 14px; display: block; }
        .active-tap:active { transform: scale(0.95); opacity: 0.8; }
        #main-app { display: none; opacity: 0; transition: opacity 0.5s ease; }
        .hidden-workout { max-height: 0 !important; opacity: 0 !important; margin: 0 !important; overflow: hidden; }
    </style>
</head>
<body>

    <div id="auth-screen" class="fixed inset-0 z-[100] bg-[#020617] flex flex-col items-center justify-center p-6">
        <img src="https://cdn-icons-png.flaticon.com/512/84/84145.png" class="w-16 h-16 invert mb-8 opacity-20">
        <h2 class="text-slate-500 font-bold text-[10px] tracking-[0.3em] uppercase mb-4">Security Challenge</h2>
        
        <input type="password" id="pin-input" inputmode="numeric" placeholder="••••" maxlength="4" 
               class="bg-slate-900 border border-slate-800 rounded-2xl p-4 w-44 text-center text-3xl tracking-[0.4em] text-blue-500 outline-none focus:border-blue-500 transition-all mb-6">
        
        <button onclick="manualUnlock()" class="bg-blue-600 hover:bg-blue-500 text-white font-black py-4 px-10 rounded-2xl text-xs uppercase tracking-widest active-tap shadow-lg shadow-blue-900/40">
            Unlock OS
        </button>

        <button onclick="clearCache()" class="mt-12 text-[8px] text-slate-700 uppercase tracking-widest font-bold">
            Reset Local Storage
        </button>
    </div>

    <div id="main-app" class="max-w-xl mx-auto px-4 pt-16 pb-32">
        <div class="glass-card p-6 rounded-[2.5rem] border-b-4 border-blue-500 mb-6">
            <span class="panel-title text-blue-400">Total Protein</span>
            <div class="flex items-baseline gap-2">
                <span id="total-p" class="text-6xl font-black">0</span>
                <span class="text-slate-500 font-black text-2xl">/ 180g</span>
            </div>
        </div>

        <div class="w-full bg-slate-800 h-2 rounded-full mb-8 overflow-hidden">
            <div id="p-bar" class="bg-blue-500 h-full transition-all duration-700 shadow-[0_0_10px_#3b82f6]" style="width: 0%"></div>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-6 text-center">
            <div class="glass-card p-4 rounded-3xl border-l-2 border-orange-500/30">
                <span class="panel-title text-orange-500 text-xs">Carbs</span>
                <p class="text-2xl font-black text-orange-400"><span id="total-c">0</span>g</p>
            </div>
            <div class="glass-card p-4 rounded-3xl border-l-2 border-yellow-500/30">
                <span class="panel-title text-yellow-500 text-xs">Fats</span>
                <p class="text-2xl font-black text-yellow-400"><span id="total-f">0</span>g</p>
            </div>
        </div>

        <div id="workout-section" class="glass-card p-6 rounded-3xl border-l-4 border-blue-500 mb-6 transition-all duration-500">
            <div class="flex justify-between items-center mb-4">
                <span class="panel-title text-blue-400 m-0">AI Workout</span>
                <div class="flex gap-2">
                    <label class="bg-emerald-500 text-black font-black w-8 h-8 rounded-full flex items-center justify-center cursor-pointer active-tap">
                        + <input type="file" id="workout-img-input" accept="image/*" class="hidden">
                    </label>
                    <button onclick="clearWorkoutData()" class="bg-red-500 text-white font-black w-8 h-8 rounded-full active-tap">-</button>
                </div>
            </div>
            <div id="workout-display" class="hidden">
                <img id="workout-thumb" class="w-20 h-20 rounded-xl object-cover border border-slate-700 mb-2">
                <div class="bg-slate-900/50 p-4 rounded-2xl border border-slate-800">
                    <p class="text-blue-400 font-black text-xl mb-1"><span id="work-val">0</span>% Intensity</p>
                    <div id="workout-summary" class="text-[10px] text-slate-300 font-mono italic"></div>
                </div>
            </div>
        </div>

        <div class="glass-card p-6 rounded-3xl mb-6">
            <div class="flex justify-between items-center mb-2">
                <span class="panel-title">Nutrition Log</span>
                <button onclick="openModal()" class="bg-emerald-500 text-black font-black w-8 h-8 rounded-full shadow-lg active-tap">+</button>
            </div>
            <div id="food-log" class="space-y-2"></div>
        </div>

        <button onclick="archiveToCloud()" class="w-full bg-white text-black font-black py-6 rounded-3xl uppercase tracking-widest text-lg active-tap shadow-2xl italic">Sync Day</button>
    </div>

    <div id="modal" class="fixed inset-0 bg-black/95 z-[110] hidden p-6 flex flex-col justify-center">
        <div class="glass-card p-6 rounded-[2rem] border border-emerald-500/30">
            <span class="panel-title">Add Entry</span>
            <input id="m-name" type="text" placeholder="Meal Name" class="w-full bg-slate-900 p-4 rounded-xl mb-4 text-white">
            <div class="grid grid-cols-3 gap-3 mb-6">
                <input id="m-p" type="number" placeholder="P" class="bg-slate-900 p-4 rounded-xl text-center">
                <input id="m-c" type="number" placeholder="C" class="bg-slate-900 p-4 rounded-xl text-center">
                <input id="m-f" type="number" placeholder="F" class="bg-slate-900 p-4 rounded-xl text-center">
            </div>
            <div class="flex gap-2">
                <button onclick="closeModal()" class="flex-1 bg-slate-800 py-4 rounded-xl font-bold">Cancel</button>
                <button onclick="logNewMeal()" class="flex-1 bg-emerald-500 text-black py-4 rounded-xl font-black">Add</button>
            </div>
        </div>
    </div>

    <script>
        const CORRECT_PIN = "0805";
        const GS_URL = "https://script.google.com/macros/s/AKfycbzyIYOLFQsOcJTZ0LCuEz6adaLcr6IOeav3SgBDGFEfpaf74yumU0oKsvLJlmP7nzeWfQ/exec";
        
        let localMeals = [];
        let workData = { score: 0, summary: "", img: "" };

        function manualUnlock() {
            const input = document.getElementById('pin-input').value;
            if (input === CORRECT_PIN) {
                document.getElementById('auth-screen').style.display = 'none';
                const main = document.getElementById('main-app');
                main.style.display = 'block';
                setTimeout(() => main.style.opacity = '1', 50);
                loadSession();
            } else {
                alert("INCORRECT PIN");
                document.getElementById('pin-input').value = "";
            }
        }

        function clearCache() {
            if(confirm("Clear all locally saved data?")) {
                localStorage.removeItem('fit_os_pro_final');
                location.reload();
            }
        }

        // Logic Functions
        async function logNewMeal() {
            const m = {
                id: Date.now(),
                name: document.getElementById('m-name').value || "Meal",
                p: parseFloat(document.getElementById('m-p').value) || 0,
                c: parseFloat(document.getElementById('m-c').value) || 0,
                f: parseFloat(document.getElementById('m-f').value) || 0,
                type: "meal"
            };
            localMeals.push(m);
            closeModal();
            refreshUI();
            await fetch(GS_URL, {method: 'POST', mode: 'no-cors', body: JSON.stringify(m)});
        }

        function refreshUI() {
            const t = localMeals.reduce((a, b) => ({p: a.p + b.p, c: a.c + b.c, f: a.f + b.f}), {p:0, c:0, f:0});
            document.getElementById('total-p').innerText = t.p.toFixed(0);
            document.getElementById('total-c').innerText = t.c.toFixed(0);
            document.getElementById('total-f').innerText = t.f.toFixed(0);
            document.getElementById('p-bar').style.width = Math.min((t.p/180)*100, 100) + "%";
            
            document.getElementById('food-log').innerHTML = localMeals.map(m => `
                <div class="flex justify-between items-center bg-slate-900/60 p-4 rounded-2xl border border-slate-800">
                    <span class="font-black uppercase text-xs">${m.name}</span>
                    <button onclick="delMeal(${m.id})" class="text-slate-600 font-bold text-[9px]">DELETE</button>
                </div>
            `).join('');
            
            localStorage.setItem('fit_os_pro_final', JSON.stringify({
                meals: localMeals, date: new Date().toLocaleDateString()
            }));
        }

        async function delMeal(id) {
            localMeals = localMeals.filter(m => m.id !== id);
            refreshUI();
            await fetch(GS_URL, {method: 'POST', mode: 'no-cors', body: JSON.stringify({action:"delete", id:id})});
        }

        function loadSession() {
            const s = JSON.parse(localStorage.getItem('fit_os_pro_final'));
            if(s && s.date === new Date().toLocaleDateString()) {
                localMeals = s.meals || [];
                refreshUI();
            }
        }

        function openModal() { document.getElementById('modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }
    </script>
</body>
</html>
